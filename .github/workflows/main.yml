name: CI

on:
  pull_request:
  push:
    branches:
      - master

concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    runs-on: ubuntu-20.04
    timeout-minutes: 10

    steps:
      - name: Project Checkout
        uses: actions/checkout@v3.1.0

      - name: Check code formatting
        run: ./scripts/static-analysis.sh all

  unit-tests:
    runs-on: ubuntu-20.04
    timeout-minutes: 10
    needs: [code-quality]

    steps:
      - name: Project Checkout
        uses: actions/checkout@v3.1.0

      - name: Setup Android Build
        uses: ./.github/actions/setup-android-build
        with:
          norris-key: ${{ secrets.NORRIS_CRYPTO_KEY }}

      - name: Run unit tests
        run: ./gradlew test

      - name: Collect all test results from all modules
        if: always()
        run: ./scripts/aggregate-test-reports.sh build/test-reports

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: unit-tests-reports
          path: build/test-reports

  assemble-apk:
    runs-on: ubuntu-20.04
    timeout-minutes: 25
    needs: [code-quality]

    steps:
      - name: Project Checkout
        uses: actions/checkout@v3.1.0

      - name: Setup Android Build
        uses: ./.github/actions/setup-android-build
        with:
          norris-key: ${{ secrets.NORRIS_CRYPTO_KEY }}

      - name: Assemble production APK
        run: ./gradlew app:assembleRelease -PtestMode=true

      - name: Archive APK
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: release-apk
          path: app/build/outputs/apk/release

      - name: Archive R8 mappings
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: release-mappings
          path: app/build/outputs/mapping/release

  espresso-prepare:
    runs-on: ubuntu-20.04
    timeout-minutes: 25
    needs: [code-quality]

    steps:
      - name: Project Checkout
        uses: actions/checkout@v3.1.0

      - name: Setup Android Build
        uses: ./.github/actions/setup-android-build
        with:
          norris-key: ${{ secrets.NORRIS_CRYPTO_KEY }}

      - name: Assemble Instrumentation tests
        run: |
          ./gradlew assembleAndroidTest -PtestMode=true

      - name: Archive Test APK
        uses: actions/upload-artifact@v3
        with:
          name: test-apks
          path: |
            app/build/outputs/apk/androidTest/release
            features/**/build/outputs/apk/androidTest/debug

  acceptance-tests:
    runs-on: ubuntu-20.04
    if: false
    timeout-minutes: 25
    needs: [assemble-apk, espresso-prepare]

    steps:
      - name: Fetch Instrumentation artefacts
        uses: actions/download-artifact@v3

      - name: Run Espresso tests with emulator.wtf
        uses: emulator-wtf/run-tests@v0.0.10
        with:
          api-token: ${{ secrets.EMULATOR_WTF_TOKEN }}
          app: release-apk/app-release.apk
          test: test-apks/app/build/outputs/apk/androidTest/release/app-release-androidTest.apk
          outputs-dir: emulator-wtf-results
          devices: model=Pixel2,version=31,atd=true
          use-orchestrator: true
          clear-package-data: true

      - name: Archive execution results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: acceptance-tests-reports
          path: emulator-wtf-results

  screenshot-tests:
    runs-on: ubuntu-20.04
    timeout-minutes: 25
    needs: [assemble-apk, espresso-prepare]
    strategy:
      fail-fast: false
      matrix:
        feature: ['facts', 'search']

    steps:
      - name: Fetch Instrumentation artefacts
        uses: actions/download-artifact@v3

      - name: Run screenshot tests
        uses: emulator-wtf/run-tests@v0.0.10
        with:
          api-token: ${{ secrets.EMULATOR_WTF_TOKEN }}
          app: release-apk/app-release.apk
          test: test-apks/features/${{ matrix.feature }}/build/outputs/apk/androidTest/debug/${{ matrix.feature }}-debug-androidTest.apk
          outputs-dir: emulator-wtf-results-${{ matrix.feature }}
          devices: model=Pixel2,version=31
          use-orchestrator: true
          clear-package-data: true

      - name: Archive execution results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: screenshot-tests-reports
          path: emulator-wtf-results-${{ matrix.feature }}

  security-analysis:
    runs-on: ubuntu-20.04
    timeout-minutes: 25
    needs: assemble-apk

    steps:
      - name: Project Checkout
        uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 0

      - name: Check leaking secrets on source files
        uses: trufflesecurity/trufflehog@v3.16.3
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1.0.5

      - name: Setup Android Build
        uses: ./.github/actions/setup-android-build
        with:
          norris-key: ${{ secrets.NORRIS_CRYPTO_KEY }}

      - name: Check security issues in project dependencies and generate SBOM
        run: ./gradlew clean ossIndexAudit

      - name: Archive CycloneDx SBOM
        uses: actions/upload-artifact@v3
        with:
          name: cyclonedx-sbom
          path: ./oss-index-cyclonedx-bom.json

      - name: Fetch APK from previous build
        uses: actions/download-artifact@v3

      - name: Analyse APK with AppSweep
        uses: guardsquare/appsweep-action@main
        env:
          APPSWEEP_API_KEY: ${{ secrets.APP_SWEEP_TOKEN }}
          COMMIT_HASH: ${{ steps.vars.outputs.sha_short }}
          INPUT_FILE: release-apk/app-release.apk
          MAPPING_FILE: release-mappings/mapping.txt

      - name: Generate Security reports with MobSF
        uses: nick-fields/retry@v2.8.2
        with:
          timeout_minutes: 1
          max_attempts: 2
          command: ./scripts/security-scan.sh ${{ secrets.NORRIS_CRYPTO_KEY }} release-apk/app-release.apk

      - name: Archive security reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: mobsf-reports

  app-size-analysis:
    runs-on: ubuntu-20.04
    timeout-minutes: 25
    needs: assemble-apk

    steps:
      - name: Project Checkout
        uses: actions/checkout@v3.1.0

      - name: Setup Android Build
        uses: ./.github/actions/setup-android-build
        with:
          norris-key: ${{ secrets.NORRIS_CRYPTO_KEY }}

      - name: Analyse AppBundle size
        run: ./gradlew app:analyzeReleaseBundle

      - name: Archive Reports
        uses: actions/upload-artifact@v3
        with:
          name: app-size-reports
          path: app/build/reports/ruler/release

  test-results-analysis:
    runs-on: ubuntu-20.04
    timeout-minutes: 25
    needs: [unit-tests, screenshot-tests]
    steps:
      - name: Fetch all artefacts
        uses: actions/download-artifact@v3

      - name: Copy all test results
        run: mkdir all-reports && mv *-tests-reports/ all-reports

      - name: Report test results to Foresight
        uses: runforesight/foresight-test-kit-action@v1.3.0
        with:
          api_key: ${{ secrets.FORESIGHT_API_KEY }}
          test_format: JUNIT
          test_framework: JUNIT
          test_path: all-reports
